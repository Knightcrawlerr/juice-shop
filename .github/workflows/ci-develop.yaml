name: juice-shop-ci-develop
on:
    push:
        branches:
            - develop

jobs:
    build-lint-test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up Node.js
              uses: actions/setup-node@v5
              with:
                  node-version: "22"
            - name: cache npm
              uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-
            - name: Install dependencies
              run: npm ci
            - name: Run tests
              run: npm test
            - name: Run API tests
              run: npm run test:api
            - name: Run lint
              run: npm run lint
            - name: Build frontend
              run: npm run build:frontend
            - name: Build server
              run: npm run build:server

    docker-build:
        runs-on: ubuntu-latest
        needs: build-lint-test
        outputs:
            SHORT_SHA: ${{ steps.vars.outputs.SHORT_SHA }}
        steps:
            - uses: actions/checkout@v5
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
            - name: Get the short SHA
              id: vars
              run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
            - name: Build and push Docker image (develop)
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: ${{ secrets.DOCKER_HUB_USERNAME }}/juice-shop:dev-${{ steps.vars.outputs.SHORT_SHA }}
                  cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/juice-shop:dev-${{ steps.vars.outputs.SHORT_SHA }}
                  cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/juice-shop:dev-${{ steps.vars.outputs.SHORT_SHA }},mode=max
    update-k8s-deployment:
        runs-on: ubuntu-latest
        needs: docker-build
        steps:
            - uses: actions/checkout@v5
              with:
                  repository: Knightcrawlerr/eks-secobs
                  token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
                  path: eks-secobs
            - name: Update Juice Shop image in Kubernetes deployment
              run: |
                  cd eks-secobs
                  sed -i "s|tag: .*|tag: \"dev-${{ needs.docker-build.outputs.SHORT_SHA }}\"|g" apps/juice-shop/values-dev.yaml
            - name: Commit changes
              run: |
                  cd eks-secobs
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add apps/juice-shop/values-dev.yaml
                  git commit -m "[CI]: Updated Juice Shop image to ${{ needs.docker-build.outputs.SHORT_SHA }}"
                  git push origin main
